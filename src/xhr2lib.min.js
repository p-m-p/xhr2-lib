/*! Copyright (c) 2012 Phil Parsons http://philparsons.co.uk/licence */
(function(h){h.$xhr=function(){var d={},j;d.supported=function(){return"undefined"!==typeof(new XMLHttpRequest).upload&&"undefined"!==typeof h.FormData&&"undefined"!==typeof h.File};d.defaultError=function(a){"function"===typeof a&&(j=a);return this};d.defaultSuccess=function(){return this};d.get=function(){var a=f(arguments);a.url+=d.serializeQS(a.url,a.data);return d.ajax(a)};d.getJSON=function(){var a=g(f(arguments),{dataType:"json"});a.url+=d.serializeQS(a.url,a.data);return d.ajax(a)};d.getXML=
function(){var a=g(f(arguments),{dataType:"xml"});a.url+=d.serializeQS(a.url,a.data);return d.ajax(a)};d.post=function(){return d.ajax(g(f(arguments),{type:"post"}))};d.sendForm=function(){var a,b=arguments[0],c=Array.prototype.slice.call(arguments,1);if(b&&"FORM"===b.nodeName)return a=new FormData(b),c.unshift(b.action||h.location.href),a=g(f(c),{type:b.method||"post",data:a}),d.ajax(a);throw Error("HTMLFormElement expected");};d.sendFile=function(){var a=f(arguments);return d.ajax(g(a,{type:"post",
headers:{"X-File-Name":a.data.name}}))};d.ajax=function(a){var b=new XMLHttpRequest,c=b.upload,a=g({progress:!1,type:"get",dataType:"html",async:!0,username:null,password:null,timeout:0},a),e,i;a.type=a.type.toLowerCase();if("object"===typeof a.data&&-1===a.data.constructor.toString().indexOf("FormData"))if("get"===a.type)a.url+=d.serializeQS(a.url,a.data),a.data=null;else{e=new FormData;for(i in a.data)a.data.hasOwnProperty(i)&&e.append(i,a.data[i]);a.data=e}if("function"===typeof a.progress)c.callback=
a.progress,c.onprogress=m;if(0<a.timeout)a.timer=setTimeout(function(){var a=b,c=k(a);a.abort();c&&c.call(void 0,{message:"Request timed out",type:"XHR2RequestTimeout"},"timeout",a.status);b=void 0;b=null},a.timeout);b.open(a.type,a.url,a.async,a.username,a.password);n(b,a.dataType,a.headers);b.xhr2data=a;b.onreadystatechange=o;b.onerror=l;b.send(a.data);return b};d.serializeQS=function(a,b){var c="";if("object"===typeof b){var c=~a.search(/\?/)?"&":"?",e;for(e in b)b.hasOwnProperty(e)&&(c+=e+"="+
b[e]+"&");c=c.substr(0,c.length-1)}return c};var f=function(a){for(var b=0,c={url:a[0]},a=Array.prototype.slice.call(a,1),e=!1;b<a.length;++b)switch(typeof a[b]){case "string":c.dataType=a[b];break;case "function":e?c.progress=a[b]:(c.success=a[b],e=!0);break;case "object":c.data=a[b]}return c},g=function(){var a={},b=0,c;if(arguments.length&&"undefined"!==typeof arguments[0])for(;b<arguments.length;++b)for(c in arguments[b])arguments[b].hasOwnProperty(c)&&(a[c]=arguments[b][c]);return a},o=function(a){var b,
c=a.target,e=c.xhr2data||{},d;if(c.readyState===c.DONE)switch(d=Math.round(c.status/100),e.timer&&clearTimeout(e.timer),d){case 2:if("function"===typeof e.success){if("json"===e.dataType)try{b=JSON.parse(c.responseText)}catch(f){}else b="xml"===e.dataType?c.responseXML:c.responseText;e.success.call(c,b)}break;case 4:case 5:l(a)}},m=function(a){a&&a.lengthComputable&&a.target.callback.call(a,100*Math.round(a.loaded/a.total))},n=function(a,b,c){var e="",d;switch((b||"").toLowerCase()){case "html":e+=
"text/html, ";break;case "json":e+="application/json, text/javascript, ";break;case "xml":e+="text/xml, application/xml, ";break;case "text":e+="text/plain, "}a.setRequestHeader("Accept",e+"*/*;q=0.01");a.setRequestHeader("X-Requested-With","XMLHttpRequest");if("object"===typeof c)for(d in c)c.hasOwnProperty(d)&&a.setRequestHeader(d,c[d])},l=function(a){var b=a.target,c;b&&(c=k(b))&&c.call(b,a,b.statusText,b.status)},k=function(a){if(a.clientData&&"function"===typeof a.clientData.error)return a.clientData.error;
if(j)return j};return d}()})(window);
